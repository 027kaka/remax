import * as React from 'react';
import { createPageConfig } from 'remax';
import { Router, CacheSwitch as Switch, CacheRoute as Route, Link, browserHistory as history, render, hd } from 'remax/web';
import 'remax/normalize.css';
import 'remax/app.css';
<%- pages.map((page, i) => `import page_${i} from '${page.path}';`).join('\n') %>
import App from './app';

hd();

<%- pages.map((page, i) => `const page_config_${i} = createPageConfig(page_${i})`).join('\n') %>
<%- pages.map((page, i) => `const page_manifest_${i} = ${JSON.stringify(page.config)}`).join('\n') %>
<%- `const app_config = ${JSON.stringify(appConfig)}\n` %>

<% const tabBarConfig = appConfig.tabBar %>
<% const hasTabBar = tabBarConfig && tabBarConfig.items && tabBarConfig.items.length > 0; %>

function TabBar() {
  const [currentPath, setCurrentPath] = React.useState(null);
  React.useEffect(() => {
    setCurrentPath(window.location.pathname);

    return history.listen((location, action) => {
      setCurrentPath(location.pathname);
    });
  }, []);

  function isActiveTab(url) {
    if (!url.startsWith('/')) {
      url = '/' + url;
    }

    return currentPath === url;
  }

  return (
    <div className="remax-tab-bar" style={{ backgroundColor: '<%- tabBarConfig.backgroundColor || '' %>' }}>
        <%- tabBarConfig.items.map((tab, i) => `
        <Link to="${tab.url}" className="remax-tab-item">
          <div className="remax-tab-item-image" style={{ backgroundImage: \`url(\$\{isActiveTab('${tab.url}') ? '${tab.activeImage || tab.image}' : '${tab.image}'\})\` }} />
          <div
            className={'remax-tab-item-title ' + (isActiveTab('${tab.url}') ? 'active' : '')}
            style={{ color: isActiveTab('${tab.url}') ? '${tabBarConfig.activeTitleColor || ''}' : '${tabBarConfig.titleColor || ''}' }}
          >
            ${tab.title}
          </div>
        </Link>
        `).join('\n') %>
    </div>
  )
}

render(
  <App>
    <Router history={history}>
      <Switch>
        <Route className="remax-cached-router-wrapper" path="/" exact={true}>
          {props => (React.createElement(page_config_0, { ...props, pageConfig: page_manifest_0, appConfig: app_config }))}
        </Route>
        <%- pages.map((page, i) => `
        <Route className="remax-cached-router-wrapper" path="/${page.route}" exact={true}>
          {props => (React.createElement(page_config_${i}, { ...props, pageConfig: page_manifest_${i}, appConfig: app_config }))}
        </Route>
        `).join('\n') %>
      </Switch>
    <% if (hasTabBar) { %>
      <TabBar />
    <% } %>
    </Router>
  </App>,
  document.getElementById('remax-app'),
);
